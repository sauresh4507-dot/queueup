<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueueUp - Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-lg sticky top-0 z-50">
            <nav class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-xl">ðŸŽ“</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Student Portal</h1>
                            <p class="text-xs text-gray-600">Book your slots & join queues</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="userDisplay" class="text-sm font-mono bg-blue-100 px-3 py-1 rounded">Student</span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                            Logout
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- Teacher Selection -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ðŸ“… Book Time Slots with Teachers</h2>
                <div class="grid md:grid-cols-3 gap-4">
                    <div id="teacherCards" class="md:col-span-3 grid md:grid-cols-3 gap-4">
                        <div class="animate-pulse bg-white rounded-lg p-4 h-32"></div>
                    </div>
                </div>
            </div>

            <!-- Slot Selection -->
            <div id="slotSelection" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800" id="slotSelectionTitle">Select Time Slot</h3>
                            <p class="text-sm text-gray-500 mt-1">Choose your preferred time (9:00 AM - 5:00 PM)</p>
                        </div>
                        <button onclick="closeSlotSelection()" class="text-gray-600 hover:text-gray-800 text-2xl font-bold">Ã—</button>
                    </div>
                    
                    <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ðŸ“… Select Date</label>
                        <input type="date" id="slotDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-xs text-gray-600 mt-2">Slots are available from 9:00 AM to 5:00 PM</p>
                    </div>

                    <div id="availableSlots" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <div class="text-gray-500 text-center py-8 col-span-full">Select a date to view available time slots</div>
                    </div>
                </div>
            </div>

            <!-- My Bookings -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ðŸ“‹ My Bookings</h2>
                <div id="myBookings" class="space-y-3">
                    <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
                        No bookings yet
                    </div>
                </div>
            </div>

            <!-- Queue Section -->
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ðŸš¶ Quick Queue</h2>
                    <div id="queueServices" class="space-y-3">
                        <div class="animate-pulse bg-white rounded-lg p-4 h-24"></div>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">My Queue Status</h2>
                    <div id="myQueue" class="bg-white rounded-lg shadow-lg p-6">
                        <p class="text-gray-500 text-center py-8">Not in any queue</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let socket = null;
        let currentTeacher = null;
        let currentUser = null;
        let userId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const userSession = sessionStorage.getItem('queueup_user');
            const userLocal = localStorage.getItem('queueup_user');
            
            if (!userSession && !userLocal) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userSession || userLocal);
            
            // Verify role is student
            if (currentUser.role !== 'student') {
                alert('Access denied. Student portal only.');
                logout();
                return;
            }

            userId = currentUser.id;
            document.getElementById('userDisplay').textContent = `${currentUser.name} (${currentUser.username})`;
            
            await loadTeachers();
            await loadMyBookings();
            initWebSocket();
            
            // Setup date picker
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('slotDate').value = today;
            document.getElementById('slotDate').min = today;
            document.getElementById('slotDate').addEventListener('change', loadSlots);
        });

        function logout() {
            sessionStorage.removeItem('queueup_user');
            localStorage.removeItem('queueup_user');
            window.location.href = 'login.html';
        }

        function initWebSocket() {
            socket = io('http://localhost:3000');
            socket.on('slot-updated', () => {
                if (currentTeacher) loadSlots();
                loadMyBookings();
            });
        }

        async function loadTeachers() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/teachers`);
                const data = await response.json();
                
                if (!data.success || !data.teachers) {
                    console.error('No teachers found');
                    document.getElementById('teacherCards').innerHTML = `
                        <div class="md:col-span-3 text-center py-8 text-gray-500">
                            No teachers available at the moment
                        </div>
                    `;
                    return;
                }
                
                const teacherHtml = data.teachers.map(teacher => `
                    <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition cursor-pointer" 
                         onclick="openSlotSelection('${teacher.id}', '${teacher.name}', '${teacher.department || 'N/A'}')">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                ${teacher.name.charAt(0)}
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${teacher.name}</h3>
                                <p class="text-sm text-gray-600">${teacher.department || 'No Department'}</p>
                            </div>
                        </div>
                        <button class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">
                            Book Slot
                        </button>
                    </div>
                `).join('');
                
                document.getElementById('teacherCards').innerHTML = teacherHtml;
            } catch (err) {
                console.error('Error loading teachers:', err);
                document.getElementById('teacherCards').innerHTML = `
                    <div class="md:col-span-3 text-center py-8 text-red-500">
                        Error loading teachers. Please try again.
                    </div>
                `;
            }
        }

        function openSlotSelection(teacherId, teacherName, department) {
            currentTeacher = { id: teacherId, name: teacherName, department };
            document.getElementById('slotSelection').classList.remove('hidden');
            document.getElementById('slotSelectionTitle').textContent = `${teacherName} - Select Time Slot`;
            loadSlots();
        }

        function closeSlotSelection() {
            document.getElementById('slotSelection').classList.add('hidden');
            currentTeacher = null;
        }

        async function loadSlots() {
            if (!currentTeacher) return;
            
            const date = document.getElementById('slotDate').value;
            if (!date) return;

            try {
                const response = await fetch(`${API_BASE_URL}/slots/teacher/${currentTeacher.id}/${date}`);
                const data = await response.json();
                
                const slots = data.slots || data.data || [];
                
                if (slots.length === 0) {
                    document.getElementById('availableSlots').innerHTML = `
                        <div class="md:col-span-4 text-center py-8 text-gray-500">
                            No slots available for this date
                        </div>
                    `;
                    return;
                }

                // Format time for display (HH:MM:SS -> HH:MM AM/PM)
                function formatTime(timeStr) {
                    if (!timeStr) return '';
                    const [hours, minutes] = timeStr.split(':');
                    const hour = parseInt(hours);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const displayHour = hour % 12 || 12;
                    return `${displayHour}:${minutes} ${ampm}`;
                }

                const slotsHtml = slots.map(slot => {
                    const available = slot.capacity - slot.booked_count;
                    const isAvailable = available > 0 && slot.status === 'available';
                    const statusClass = isAvailable 
                        ? 'bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 hover:border-green-500 hover:shadow-xl' 
                        : 'bg-gray-100 border-2 border-gray-300 opacity-60';
                    const textClass = isAvailable ? 'text-green-700' : 'text-gray-500';
                    
                    return `
                        <div class="${statusClass} rounded-xl p-5 text-center transition-all duration-200 ${isAvailable ? 'cursor-pointer transform hover:scale-105' : 'cursor-not-allowed'}" 
                             onclick="${isAvailable ? `bookSlot('${slot.id}')` : ''}">
                            <div class="text-2xl font-bold ${textClass} mb-1">
                                ${formatTime(slot.start_time)}
                            </div>
                            <div class="text-xs text-gray-500 mb-3">to ${formatTime(slot.end_time)}</div>
                            <div class="mt-2">
                                ${isAvailable ? (
                                    `<span class="inline-block px-3 py-1 bg-green-500 text-white text-xs font-semibold rounded-full">
                                        Available
                                    </span>`
                                ) : (
                                    `<span class="inline-block px-3 py-1 bg-gray-400 text-white text-xs font-semibold rounded-full">
                                        ${slot.booked_count >= slot.capacity ? 'Booked' : 'Unavailable'}
                                    </span>`
                                )}
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('availableSlots').innerHTML = slotsHtml;
            } catch (err) {
                console.error('Error loading slots:', err);
            }
        }

        async function bookSlot(slotId) {
            const purpose = prompt('Purpose of booking (optional):');
            
            try {
                const response = await fetch(`${API_BASE_URL}/slots/book`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        slotId, 
                        userId, 
                        userType: 'student',
                        purpose: purpose || ''
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('âœ… Slot booked successfully!', 'success');
                    await loadSlots();
                    await loadMyBookings();
                    closeSlotSelection();
                }
            } catch (err) {
                console.error('Error booking slot:', err);
                showNotification('Failed to book slot', 'error');
            }
        }

        async function loadMyBookings() {
            try {
                const response = await fetch(`${API_BASE_URL}/slots/student-bookings/${userId}`);
                const data = await response.json();
                
                const bookings = data.bookings || data.data || [];
                
                if (bookings.length === 0) {
                    document.getElementById('myBookings').innerHTML = `
                        <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
                            No bookings yet
                        </div>
                    `;
                    return;
                }

                const bookingsHtml = bookings.map(booking => `
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-lg text-gray-800">${booking.teacher_name || 'Teacher'}</h4>
                                <p class="text-sm text-gray-600">${booking.date} â€¢ ${booking.start_time} - ${booking.end_time}</p>
                                ${booking.purpose ? `<p class="text-xs text-gray-500 mt-1">Purpose: ${booking.purpose}</p>` : ''}
                            </div>
                            <span class="px-3 py-1 bg-green-100 text-green-700 text-xs rounded-full font-semibold">
                                ${booking.status}
                            </span>
                        </div>
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-center bg-blue-50 p-3 rounded flex-1 mr-2">
                                <p class="text-xs text-gray-600">Start Time</p>
                                <p class="text-xl font-bold text-blue-600">${booking.start_time}</p>
                            </div>
                            <div class="text-center bg-blue-50 p-3 rounded flex-1 ml-2">
                                <p class="text-xs text-gray-600">End Time</p>
                                <p class="text-xl font-bold text-blue-600">${booking.end_time}</p>
                            </div>
                        </div>
                        <button onclick="cancelBooking('${booking.id}')" 
                                class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                            Cancel Booking
                        </button>
                    </div>
                `).join('');
                
                document.getElementById('myBookings').innerHTML = bookingsHtml;
            } catch (err) {
                console.error('Error loading bookings:', err);
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/slots/cancel/${bookingId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                
                if (response.ok) {
                    showNotification('Booking cancelled', 'success');
                    await loadMyBookings();
                }
            } catch (err) {
                console.error('Error cancelling booking:', err);
                showNotification('Failed to cancel booking', 'error');
            }
        }

        async function joinQueue(serviceId) {
            try {
                const response = await fetch(`${API_BASE_URL}/queue/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serviceId, userId })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification(`Joined queue! Position: #${result.data.position}`, 'success');
                }
            } catch (err) {
                console.error('Error joining queue:', err);
                showNotification('Failed to join queue', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const bgColor = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            }[type];

            const notification = document.createElement('div');
            notification.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg fixed bottom-4 right-4 z-50 animate-bounce`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html>