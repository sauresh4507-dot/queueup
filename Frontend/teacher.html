<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueueUp - Teacher Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-screen">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-lg sticky top-0 z-50">
            <nav class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-emerald-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-xl">üë®‚Äçüè´</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Teacher Portal</h1>
                            <p class="text-xs text-gray-600" id="teacherName">Welcome!</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        Logout
                    </button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- All Teachers Section -->
            <div class="mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üë• College Faculty Directory</h2>
                    <p class="text-sm text-gray-600 mb-4">View all teachers, chancellors, and HODs in the system</p>
                    <div id="allTeachers" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div class="animate-pulse bg-gray-200 rounded-lg p-4 h-24"></div>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-8">
                <!-- Left: Student Appointments -->
                <div class="md:col-span-2 space-y-6">
                    <!-- Book Colleague's Schedule -->
                    <div id="colleagueBookingSection" class="bg-white rounded-lg shadow-lg p-6 hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">ü§ù Book <span id="colleagueNameHeader"></span>'s Schedule</h2>
                        <button onclick="closeColleagueBooking()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl font-bold">‚úï</button>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Select Date</label>
                                <input type="date" id="colleagueSlotDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>

                            <div class="border-t pt-4">
                                <h3 class="font-semibold text-gray-800 mb-3">Available Slots</h3>
                                <div id="colleagueAvailableSlots" class="space-y-2">
                                    <p class="text-gray-500 text-center py-4 text-sm">Select a date to see available slots</p>
                                </div>
                            </div>

                            <div class="border-t pt-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Purpose of Meeting</label>
                                <input type="text" id="colleagueBookingPurpose" placeholder="e.g., Project discussion, Mentorship" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Create Office Hours -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">üïê Create Office Hours</h2>
                        
                        <div class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                                    <input type="date" id="slotDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Capacity per Slot</label>
                                    <input type="number" id="slotCapacity" value="1" min="1" max="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>

                            <div class="border-t pt-4">
                                <h3 class="font-semibold text-gray-800 mb-3">Time Slots</h3>
                                <div id="timeSlotInputs" class="space-y-2">
                                    <div class="flex gap-2 items-center">
                                        <input type="time" class="slot-start flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                                        <span class="text-gray-600">to</span>
                                        <input type="time" class="slot-end flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                                        <button onclick="removeSlotInput(this)" class="text-red-500 hover:text-red-700 px-2">‚úï</button>
                                    </div>
                                </div>
                                <button onclick="addSlotInput()" class="mt-2 text-green-600 hover:text-green-700 text-sm font-semibold">
                                    + Add Time Slot
                                </button>
                            </div>

                            <button onclick="createSlots()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                                Create Office Hours
                            </button>
                        </div>
                    </div>

                    <!-- Student Appointments -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">üìÖ Student Appointments</h2>
                            <button onclick="loadAppointments()" class="text-sm text-blue-600 hover:text-blue-700">
                                üîÑ Refresh
                            </button>
                        </div>
                        <div id="studentAppointments" class="space-y-3">
                            <div class="text-gray-500 text-center py-4">No appointments yet</div>
                        </div>
                    </div>

                    <!-- My Colleague Bookings -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">ü§ù My Colleague Bookings</h2>
                            <button onclick="loadMyColleagueBookings()" class="text-sm text-blue-600 hover:text-blue-700">
                                üîÑ Refresh
                            </button>
                        </div>
                        <div id="myColleagueBookings" class="space-y-3">
                            <div class="text-gray-500 text-center py-4">No colleague bookings yet</div>
                        </div>
                    </div>
                </div>

                <!-- Right: Stats & Today's Schedule -->
                <div class="space-y-6">
                    <!-- Quick Stats -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Quick Stats</h3>
                        <div class="space-y-3">
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600">Today</p>
                                <p id="todayCount" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600">This Week</p>
                                <p id="weekCount" class="text-3xl font-bold text-blue-600">0</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600">Total</p>
                                <p id="totalCount" class="text-3xl font-bold text-purple-600">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Schedule -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìÜ Today's Schedule</h3>
                        <div id="todaySchedule" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-gray-500 text-center py-4 text-sm">No appointments today</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let socket = null;
        let currentUser = null;
        let selectedColleague = null; // New variable to store the selected colleague

        function getAuthHeaders() {
            const userSession = sessionStorage.getItem('queueup_user');
            const userLocal = localStorage.getItem('queueup_user');
            const user = JSON.parse(userSession || userLocal);
            const token = user ? user.token : '';
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
            console.log('Generated Auth Headers:', headers); // Debugging
            return headers;
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const userSession = sessionStorage.getItem('queueup_user');
            const userLocal = localStorage.getItem('queueup_user');
            
            if (!userSession && !userLocal) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userSession || userLocal);
            
            if (currentUser.role !== 'teacher') {
                alert('Access denied. Teachers only.');
                logout();
                return;
            }

            document.getElementById('teacherName').textContent = `${currentUser.name}`;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('slotDate').value = today;
            document.getElementById('slotDate').min = today;
            
            await loadAllTeachers();
            await loadAppointments();
            await loadMyColleagueBookings(); // Load colleague bookings on page load
            initWebSocket();
        });

        function logout() {
            sessionStorage.removeItem('queueup_user');
            localStorage.removeItem('queueup_user');
            window.location.href = 'login.html';
        }

        function initWebSocket() {
            socket = io('http://localhost:3000');
            socket.on('slot-updated', () => {
                loadAppointments();
            });
        }

        async function loadAllTeachers() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/teachers`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (!data.success || !data.teachers || data.teachers.length === 0) {
                    document.getElementById('allTeachers').innerHTML = `
                        <div class="col-span-full text-center py-8 text-gray-500">
                            No teachers found
                        </div>
                    `;
                    return;
                }

                // Sort teachers: Chancellors first, then HODs, then regular teachers
                const sortedTeachers = data.teachers.sort((a, b) => {
                    const aIsChancellor = a.name.toLowerCase().includes('chancellor');
                    const bIsChancellor = b.name.toLowerCase().includes('chancellor');
                    const aIsHOD = a.name.toLowerCase().includes('hod');
                    const bIsHOD = b.name.toLowerCase().includes('hod');
                    
                    if (aIsChancellor && !bIsChancellor) return -1;
                    if (!aIsChancellor && bIsChancellor) return 1;
                    if (aIsHOD && !bIsHOD && !aIsChancellor) return -1;
                    if (!aIsHOD && bIsHOD && !bIsChancellor) return 1;
                    return a.name.localeCompare(b.name);
                });

                const teacherHtml = sortedTeachers.map(teacher => {
                    const isCurrentUser = teacher.id === currentUser.id;
                    const isChancellor = teacher.name.toLowerCase().includes('chancellor');
                    const isHOD = teacher.name.toLowerCase().includes('hod');
                    const badge = isChancellor ? 'bg-purple-100 text-purple-800' : 
                                 isHOD ? 'bg-blue-100 text-blue-800' : 
                                 'bg-green-100 text-green-800';
                    const roleLabel = isChancellor ? 'Chancellor' : 
                                     isHOD ? 'HOD' : 
                                     'Teacher';
                    
                    return `
                        <div class="bg-white border-2 ${isCurrentUser ? 'border-green-500' : 'border-gray-200'} rounded-lg p-4 hover:shadow-lg transition ${isCurrentUser ? 'bg-green-50' : ''} ${isCurrentUser ? '' : 'cursor-pointer'}"
                             ${isCurrentUser ? '' : `onclick="showColleagueBooking('${teacher.id}', '${teacher.name}')"`}>
                            <div class="flex items-start gap-3 mb-2">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                                    ${teacher.name.charAt(0)}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-bold text-gray-800 text-sm truncate">${teacher.name}</h3>
                                    <p class="text-xs text-gray-600 truncate">${teacher.department || 'No Department'}</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-xs px-2 py-1 rounded-full font-semibold ${badge}">
                                    ${roleLabel}
                                </span>
                                ${isCurrentUser ? '<span class="text-xs text-green-600 font-semibold">(You)</span>' : ''}
                            </div>
                            ${teacher.email ? `<p class="text-xs text-gray-500 mt-2 truncate">${teacher.email}</p>` : ''}
                        </div>
                    `;
                }).join('');
                
                document.getElementById('allTeachers').innerHTML = teacherHtml;
            } catch (err) {
                console.error('Error loading teachers:', err);
                document.getElementById('allTeachers').innerHTML = `
                    <div class="col-span-full text-center py-8 text-red-500">
                        Error loading teachers. Please try again.
                    </div>
                `;
            }
        }

        function addSlotInput() {
            const container = document.getElementById('timeSlotInputs');
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center';
            div.innerHTML = `
                <input type="time" class="slot-start flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                <span class="text-gray-600">to</span>
                <input type="time" class="slot-end flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                <button onclick="removeSlotInput(this)" class="text-red-500 hover:text-red-700 px-2">‚úï</button>
            `;
            container.appendChild(div);
        }

        function removeSlotInput(btn) {
            btn.parentElement.remove();
        }

        async function createSlots() {
            const date = document.getElementById('slotDate').value;
            const capacity = parseInt(document.getElementById('slotCapacity').value);
            
            if (!date) {
                showNotification('Please select a date', 'error');
                return;
            }

            const slots = [];
            document.querySelectorAll('#timeSlotInputs > div').forEach(div => {
                const start = div.querySelector('.slot-start').value;
                const end = div.querySelector('.slot-end').value;
                if (start && end) {
                    slots.push({ startTime: start, endTime: end, capacity });
                }
            });

            if (slots.length === 0) {
                showNotification('Please add at least one time slot', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/slots/create`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ 
                        teacherId: currentUser.id, 
                        date, 
                        slots 
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(`‚úÖ Created ${slots.length} time slots!`, 'success');
                    document.getElementById('timeSlotInputs').innerHTML = `
                        <div class="flex gap-2 items-center">
                            <input type="time" class="slot-start flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            <span class="text-gray-600">to</span>
                            <input type="time" class="slot-end flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            <button onclick="removeSlotInput(this)" class="text-red-500 hover:text-red-700 px-2">‚úï</button>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error creating slots:', err);
                showNotification('Failed to create slots', 'error');
            }
        }

        async function loadAppointments() {
            try {
                const response = await fetch(`${API_BASE_URL}/slots/teacher-appointments/${currentUser.id}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (!data.success || data.appointments.length === 0) {
                    document.getElementById('studentAppointments').innerHTML = 
                        '<div class="text-gray-500 text-center py-4">No appointments yet</div>';
                    document.getElementById('todaySchedule').innerHTML = 
                        '<div class="text-gray-500 text-center py-4 text-sm">No appointments today</div>';
                    updateStats(0, 0, 0);
                    return;
                }

                const appointments = data.appointments;
                const today = new Date().toISOString().split('T')[0];
                const todayAppts = appointments.filter(a => a.date === today);
                
                // Calculate stats
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);
                
                const weekAppts = appointments.filter(a => {
                    const aptDate = new Date(a.date);
                    return aptDate >= weekStart && aptDate < weekEnd;
                });

                updateStats(todayAppts.length, weekAppts.length, appointments.length);

                // All appointments
                const html = appointments.map(apt => {
                    const isPast = new Date(apt.date + 'T' + apt.end_time) < new Date();
                    const isToday = apt.date === today;
                    
                    return `
                        <div class="border-l-4 ${isToday ? 'border-green-500 bg-green-50' : isPast ? 'border-gray-400 bg-gray-50' : 'border-blue-500 bg-blue-50'} p-4 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="font-bold text-gray-800">${apt.student_name}</p>
                                    <p class="text-xs text-gray-600">${apt.student_email}</p>
                                </div>
                                ${isToday ? '<span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded font-semibold">TODAY</span>' : ''}
                            </div>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div class="text-center bg-white p-2 rounded">
                                    <p class="text-xs text-gray-600">Date</p>
                                    <p class="font-semibold text-sm">${apt.date}</p>
                                </div>
                                <div class="text-center bg-white p-2 rounded">
                                    <p class="text-xs text-gray-600">Time</p>
                                    <p class="font-semibold text-sm">${apt.start_time}</p>
                                </div>
                                <div class="text-center bg-white p-2 rounded">
                                    <p class="text-xs text-gray-600">To</p>
                                    <p class="font-semibold text-sm">${apt.end_time}</p>
                                </div>
                            </div>
                            <div class="bg-white p-2 rounded">
                                <p class="text-xs text-gray-600 font-semibold">Purpose:</p>
                                <p class="text-sm text-gray-800">${apt.purpose}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('studentAppointments').innerHTML = html;

                // Today's schedule
                if (todayAppts.length > 0) {
                    const todayHtml = todayAppts.map(apt => `
                        <div class="bg-green-50 border border-green-200 p-3 rounded-lg">
                            <p class="font-bold text-sm text-gray-800">${apt.start_time} - ${apt.end_time}</p>
                            <p class="text-xs text-gray-600">${apt.student_name}</p>
                            <p class="text-xs text-gray-500">${apt.purpose}</p>
                        </div>
                    `).join('');
                    document.getElementById('todaySchedule').innerHTML = todayHtml;
                } else {
                    document.getElementById('todaySchedule').innerHTML = 
                        '<div class="text-gray-500 text-center py-4 text-sm">No appointments today</div>';
                }
            } catch (err) {
                console.error('Error loading appointments:', err);
            }
        }

        function updateStats(today, week, total) {
            document.getElementById('todayCount').textContent = today;
            document.getElementById('weekCount').textContent = week;
            document.getElementById('totalCount').textContent = total;
        }

        function showNotification(message, type = 'info') {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            const notification = document.createElement('div');
            notification.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg fixed bottom-4 right-4 z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showColleagueBooking(colleagueId, colleagueName) {
            selectedColleague = { id: colleagueId, name: colleagueName };
            document.getElementById('colleagueNameHeader').textContent = colleagueName;
            document.getElementById('colleagueBookingSection').classList.remove('hidden');
            // Scroll to the booking section
            document.getElementById('colleagueBookingSection').scrollIntoView({ behavior: 'smooth' });

            // Set min date for colleague slot booking to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('colleagueSlotDate').value = today;
            document.getElementById('colleagueSlotDate').min = today;
            
            loadColleagueSlots(colleagueId, today);
        }

        function closeColleagueBooking() {
            selectedColleague = null;
            document.getElementById('colleagueBookingSection').classList.add('hidden');
            document.getElementById('colleagueAvailableSlots').innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">Select a date to see available slots</p>';
            document.getElementById('colleagueBookingPurpose').value = '';
        }

        document.getElementById('colleagueSlotDate').addEventListener('change', (event) => {
            if (selectedColleague) {
                loadColleagueSlots(selectedColleague.id, event.target.value);
            }
        });

        async function loadColleagueSlots(colleagueId, date) {
            try {
                console.log('üîç Loading slots for colleague:', colleagueId, 'on date:', date);
                const response = await fetch(`${API_BASE_URL}/teacher-bookings/colleague-slots/${colleagueId}/${date}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                console.log('loadColleagueSlots response:', data); // Debugging

                const slotsContainer = document.getElementById('colleagueAvailableSlots');
                slotsContainer.innerHTML = '';

                if (!data.success || data.data.length === 0) {
                    slotsContainer.innerHTML = `<p class="text-gray-500 text-center py-4 text-sm">No available slots for ${date || 'this date'}<br><span class="text-xs text-gray-400">Make sure you're selecting the same date the slots were created</span></p>`;
                    return;
                }

                data.data.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.className = 'bg-blue-50 border border-blue-200 p-3 rounded-lg flex justify-between items-center';
                    slotElement.innerHTML = `
                        <div>
                            <p class="font-bold text-sm text-gray-800">${slot.start_time} - ${slot.end_time}</p>
                            <p class="text-xs text-gray-600">Capacity: ${slot.capacity - slot.booked_count} available</p>
                        </div>
                        <button onclick="bookColleagueSlot('${slot.id}', '${colleagueId}')" 
                                class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-700 ${slot.capacity - slot.booked_count === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${slot.capacity - slot.booked_count === 0 ? 'disabled' : ''}>
                            Book Now
                        </button>
                    `;
                    slotsContainer.appendChild(slotElement);
                });
            } catch (err) {
                console.error('Error loading colleague slots:', err);
                showNotification('Failed to load colleague slots', 'error');
            }
        }

        async function bookColleagueSlot(slotId, colleagueTeacherId) {
            if (!currentUser || !selectedColleague) {
                showNotification('Please select a colleague first', 'error');
                return;
            }

            const purpose = document.getElementById('colleagueBookingPurpose').value;
            if (!purpose) {
                showNotification('Please enter a purpose for the meeting', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/teacher-bookings/book`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        teacherId: currentUser.id,
                        colleagueTeacherId: colleagueTeacherId,
                        slotId: slotId,
                        purpose: purpose
                    })
                });
                const result = await response.json();
                console.log('bookColleagueSlot response:', result); // Debugging
                if (result.success) {
                    showNotification('‚úÖ Booking with colleague successful!', 'success');
                    closeColleagueBooking();
                    loadMyColleagueBookings(); // Refresh the list of colleague bookings
                    loadColleagueSlots(colleagueTeacherId, document.getElementById('colleagueSlotDate').value); // Refresh colleague's slots
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (err) {
                console.error('Error booking colleague slot:', err);
                showNotification('Failed to book colleague slot', 'error');
            }
        }

        async function loadMyColleagueBookings() {
            try {
                const response = await fetch(`${API_BASE_URL}/teacher-bookings/my-colleague-bookings/${currentUser.id}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                console.log('loadMyColleagueBookings response:', data); // Debugging

                const bookingsContainer = document.getElementById('myColleagueBookings');
                bookingsContainer.innerHTML = '';

                if (!data.success || data.bookings.length === 0) {
                    bookingsContainer.innerHTML = '<div class="text-gray-500 text-center py-4">No colleague bookings yet</div>';
                    return;
                }

                data.bookings.forEach(booking => {
                    const bookingElement = document.createElement('div');
                    bookingElement.className = 'border-l-4 border-purple-500 bg-purple-50 p-4 rounded-lg';
                    bookingElement.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-bold text-gray-800">${booking.colleague_name}</p>
                                <p class="text-xs text-gray-600">${booking.colleague_email}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <div class="text-center bg-white p-2 rounded">
                                <p class="text-xs text-gray-600">Date</p>
                                <p class="font-semibold text-sm">${booking.date}</p>
                            </div>
                            <div class="text-center bg-white p-2 rounded">
                                <p class="text-xs text-gray-600">Time</p>
                                <p class="font-semibold text-sm">${booking.start_time}</p>
                            </div>
                            <div class="text-center bg-white p-2 rounded">
                                <p class="text-xs text-gray-600">To</p>
                                <p class="font-semibold text-sm">${booking.end_time}</p>
                            </div>
                        </div>
                        <div class="bg-white p-2 rounded">
                            <p class="text-xs text-gray-600 font-semibold">Purpose:</p>
                            <p class="text-sm text-gray-800">${booking.purpose}</p>
                        </div>
                        <button onclick="cancelTeacherBooking('${booking.id}')" class="mt-3 w-full bg-red-500 text-white py-2 rounded-lg text-sm hover:bg-red-600">Cancel Booking</button>
                    `;
                    bookingsContainer.appendChild(bookingElement);
                });
            } catch (err) {
                console.error('Error loading colleague bookings:', err);
                showNotification('Failed to load colleague bookings', 'error');
            }
        }

        async function cancelTeacherBooking(bookingId) {
            if (!currentUser) {
                showNotification('User not authenticated', 'error');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/teacher-bookings/cancel/${bookingId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ teacherId: currentUser.id })
                });
                const result = await response.json();
                console.log('cancelTeacherBooking response:', result); // Debugging
                if (result.success) {
                    showNotification('‚úÖ Booking cancelled successfully!', 'success');
                    loadMyColleagueBookings();
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (err) {
                console.error('Error cancelling teacher booking:', err);
                showNotification('Failed to cancel booking', 'error');
            }
        }
    </script>
</body>
</html>