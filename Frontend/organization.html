<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueueUp - Organization Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-100 min-h-screen">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-lg sticky top-0 z-50">
            <nav class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-xl">üè¢</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Organization Portal</h1>
                            <p class="text-xs text-gray-600">Book event spaces & meeting rooms</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="userDisplay" class="text-sm font-mono bg-purple-100 px-3 py-1 rounded">Org</span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                            Logout
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- Hero Section -->
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg shadow-xl p-8 mb-8 text-white">
                <h2 class="text-3xl font-bold mb-2">Welcome, Organization!</h2>
                <p class="text-purple-100">Book meeting rooms, auditoriums, and campus facilities for your events</p>
            </div>

            <div class="grid md:grid-cols-3 gap-8">
                <!-- Left Column: Booking -->
                <div class="md:col-span-2 space-y-6">
                    <!-- Facilities -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">üèõÔ∏è Available Facilities</h2>
                        <div id="facilities" class="grid md:grid-cols-2 gap-4">
                            <div class="animate-pulse bg-gray-200 rounded-lg p-4 h-32"></div>
                        </div>
                    </div>

                    <!-- Booking Form -->
                    <div id="bookingForm" class="hidden bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Book Facility</h3>
                            <button onclick="closeBookingForm()" class="text-gray-600 hover:text-gray-800">‚úï</button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Organization Name</label>
                                <input type="text" id="orgName" placeholder="Enter your organization name" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Event Purpose</label>
                                <input type="text" id="eventPurpose" placeholder="e.g., Tech Talk, Workshop, Meeting" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Expected Attendees</label>
                                <input type="number" id="attendees" placeholder="Number of people" min="1"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                                <input type="date" id="bookingDate" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>

                            <div id="availableSlots" class="border-t pt-4">
                                <h4 class="font-semibold text-gray-800 mb-3">Select Time Slot</h4>
                                <div id="slotsList" class="grid grid-cols-2 gap-3">
                                    <div class="text-gray-500 text-center py-4">Select a date first</div>
                                </div>
                            </div>

                            <button onclick="submitBooking()" 
                                    class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700">
                                Confirm Booking
                            </button>
                        </div>
                    </div>

                    <!-- My Bookings -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">üìã My Bookings</h2>
                        <div id="myBookings" class="space-y-3">
                            <div class="text-gray-500 text-center py-4">No bookings yet</div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Info & Stats -->
                <div class="space-y-6">
                    <!-- Quick Stats -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Statistics</h3>
                        <div class="space-y-3">
                            <div class="bg-purple-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600">Total Bookings</p>
                                <p id="totalBookings" class="text-3xl font-bold text-purple-600">0</p>
                            </div>
                            <div class="bg-pink-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600">Upcoming Events</p>
                                <p id="upcomingEvents" class="text-3xl font-bold text-pink-600">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Guidelines -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">üìù Booking Guidelines</h3>
                        <ul class="text-sm text-gray-600 space-y-2">
                            <li class="flex items-start gap-2">
                                <span class="text-purple-600">‚Ä¢</span>
                                <span>Book at least 3 days in advance</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-purple-600">‚Ä¢</span>
                                <span>Cancellations allowed 24 hours prior</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-purple-600">‚Ä¢</span>
                                <span>Maximum 4 hours per booking</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-purple-600">‚Ä¢</span>
                                <span>Leave facility as you found it</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Contact -->
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-bold mb-2">Need Help?</h3>
                        <p class="text-sm text-purple-100 mb-3">Contact facility management</p>
                        <button class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold text-sm hover:bg-purple-50">
                            üìû Contact Support
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let socket = null;
        let currentUser = null;
        let userId = null;
        let currentFacility = null;
        let selectedSlot = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const userSession = sessionStorage.getItem('queueup_user');
            const userLocal = localStorage.getItem('queueup_user');
            
            if (!userSession && !userLocal) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userSession || userLocal);
            
            // Verify role is organization
            const orgRoles = ['organization', 'org'];
            if (!orgRoles.includes(currentUser.role.toLowerCase())) {
                alert('Access denied. Organization portal only.');
                logout();
                return;
            }

            userId = currentUser.id;
            document.getElementById('userDisplay').textContent = `${currentUser.name} (${currentUser.username})`;
            
            const today = new Date();
            today.setDate(today.getDate() + 3); // 3 days advance booking
            const minDate = today.toISOString().split('T')[0];
            document.getElementById('bookingDate').min = minDate;
            document.getElementById('bookingDate').addEventListener('change', loadSlots);
            
            await loadFacilities();
            await loadMyBookings();
            initWebSocket();
        });

        function logout() {
            sessionStorage.removeItem('queueup_user');
            localStorage.removeItem('queueup_user');
            window.location.href = 'login.html';
        }

        function initWebSocket() {
            socket = io('http://localhost:3000');
            socket.on('slot-updated', () => {
                if (currentFacility) loadSlots();
                loadMyBookings();
            });
        }

        async function loadFacilities() {
            try {
                const response = await fetch(`${API_BASE_URL}/services`);
                const data = await response.json();
                
                const html = data.data.map(facility => `
                    <div class="border-2 border-purple-200 rounded-lg p-6 hover:border-purple-400 hover:shadow-lg transition cursor-pointer"
                         onclick="openBookingForm('${facility.id}', '${facility.name}')">
                        <div class="text-3xl mb-3">üèõÔ∏è</div>
                        <h3 class="font-bold text-lg text-gray-800 mb-2">${facility.name}</h3>
                        <p class="text-sm text-gray-600 mb-3">${facility.description || ''}</p>
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>Capacity: ${facility.booths * 50} people</span>
                        </div>
                        <button class="mt-4 w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                            Book Now
                        </button>
                    </div>
                `).join('');
                
                document.getElementById('facilities').innerHTML = html;
            } catch (err) {
                console.error('Error loading facilities:', err);
            }
        }

        function openBookingForm(facilityId, facilityName) {
            currentFacility = { id: facilityId, name: facilityName };
            document.getElementById('bookingForm').classList.remove('hidden');
            document.querySelector('#bookingForm h3').textContent = `Book ${facilityName}`;
            
            const date = document.getElementById('bookingDate').value;
            if (date) loadSlots();
        }

        function closeBookingForm() {
            document.getElementById('bookingForm').classList.add('hidden');
            currentFacility = null;
            selectedSlot = null;
        }

        async function loadSlots() {
            if (!currentFacility) return;
            
            const date = document.getElementById('bookingDate').value;
            if (!date) return;

            try {
                const response = await fetch(`${API_BASE_URL}/slots/${currentFacility.id}/${date}`);
                const data = await response.json();
                
                if (data.data.length === 0) {
                    document.getElementById('slotsList').innerHTML = 
                        '<div class="col-span-2 text-center py-4 text-gray-500">No slots available</div>';
                    return;
                }

                const html = data.data.map(slot => {
                    const available = slot.capacity - slot.booked_count;
                    const isAvailable = available > 0;
                    
                    return `
                        <div class="border-2 ${isAvailable ? 'border-purple-200 hover:border-purple-400 cursor-pointer' : 'border-gray-200 opacity-50'} 
                                    rounded-lg p-3 text-center transition ${selectedSlot === slot.id ? 'bg-purple-100 border-purple-500' : ''}"
                             onclick="${isAvailable ? `selectSlot('${slot.id}', '${slot.start_time}', '${slot.end_time}')` : ''}">
                            <div class="font-bold text-purple-600">${slot.start_time}</div>
                            <div class="text-xs text-gray-600">to</div>
                            <div class="font-bold text-purple-600">${slot.end_time}</div>
                            <div class="text-xs mt-1 ${isAvailable ? 'text-green-600' : 'text-red-600'}">
                                ${isAvailable ? `${available} available` : 'Full'}
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('slotsList').innerHTML = html;
            } catch (err) {
                console.error('Error loading slots:', err);
            }
        }

        function selectSlot(slotId, start, end) {
            selectedSlot = slotId;
            loadSlots(); // Refresh to show selection
        }

        async function submitBooking() {
            const orgName = document.getElementById('orgName').value;
            const eventPurpose = document.getElementById('eventPurpose').value;
            const attendees = document.getElementById('attendees').value;
            
            if (!orgName || !eventPurpose || !attendees || !selectedSlot) {
                showNotification('Please fill all fields and select a slot', 'error');
                return;
            }

            const purpose = `${orgName} - ${eventPurpose} (${attendees} attendees)`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/slots/book`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        slotId: selectedSlot,
                        userId,
                        userType: 'organization',
                        purpose
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ Facility booked successfully!', 'success');
                    closeBookingForm();
                    document.getElementById('orgName').value = '';
                    document.getElementById('eventPurpose').value = '';
                    document.getElementById('attendees').value = '';
                    await loadMyBookings();
                }
            } catch (err) {
                console.error('Error booking:', err);
                showNotification('Failed to book facility', 'error');
            }
        }

        async function loadMyBookings() {
            try {
                const response = await fetch(`${API_BASE_URL}/slots/my-bookings/${userId}`);
                const data = await response.json();
                
                document.getElementById('totalBookings').textContent = data.data.length;
                
                const upcoming = data.data.filter(b => new Date(b.date) >= new Date());
                document.getElementById('upcomingEvents').textContent = upcoming.length;

                if (data.data.length === 0) {
                    document.getElementById('myBookings').innerHTML = 
                        '<div class="text-gray-500 text-center py-4">No bookings yet</div>';
                    return;
                }

                const html = data.data.map(booking => `
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 border-l-4 border-purple-500">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-gray-800">${booking.service_name}</h4>
                                <p class="text-sm text-gray-600">${booking.date}</p>
                            </div>
                            <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded font-semibold">
                                ${booking.status}
                            </span>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <div class="bg-white p-2 rounded flex-1 text-center">
                                <p class="text-xs text-gray-600">Start</p>
                                <p class="font-bold text-purple-600">${booking.start_time}</p>
                            </div>
                            <div class="bg-white p-2 rounded flex-1 text-center">
                                <p class="text-xs text-gray-600">End</p>
                                <p class="font-bold text-purple-600">${booking.end_time}</p>
                            </div>
                        </div>
                        ${booking.purpose ? `<p class="text-xs text-gray-600 mb-3">${booking.purpose}</p>` : ''}
                        <button onclick="cancelBooking('${booking.id}')" 
                                class="w-full bg-red-500 text-white py-2 rounded-lg text-sm hover:bg-red-600">
                            Cancel Booking
                        </button>
                    </div>
                `).join('');
                
                document.getElementById('myBookings').innerHTML = html;
            } catch (err) {
                console.error('Error loading bookings:', err);
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Cancel this booking? This action cannot be undone.')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/slots/cancel/${bookingId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                
                if (response.ok) {
                    showNotification('Booking cancelled', 'success');
                    await loadMyBookings();
                }
            } catch (err) {
                console.error('Error cancelling:', err);
                showNotification('Failed to cancel booking', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const bgColor = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-purple-500'
            }[type];

            const notification = document.createElement('div');
            notification.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg fixed bottom-4 right-4 z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html>